# Claude Code Core Rules

## 1. MCP-FIRST RULE (MANDATORY)

**ALWAYS use MCP tools BEFORE falling back to CLI binaries.**

```yaml
priority_order:
  search:
    1st: mcp__grepai__*          # Semantic code search (ALWAYS FIRST)
    fallback: Grep tool          # Only if grepai unavailable/fails
  github:
    1st: mcp__github__*          # PR, Issues, Repos
    fallback: gh CLI
  code_quality:
    1st: mcp__codacy__*          # Code analysis
    fallback: codacy-cli
  browser:
    1st: mcp__playwright__*      # Browser automation
    fallback: npx playwright
  docs:
    1st: mcp__context7__*        # Library documentation
    fallback: WebFetch
```

**Why MCP-first:**
- Pre-configured authentication (tokens in mcp.json)
- Structured JSON responses (no text parsing)
- Single source of truth for credentials
- NEVER ask user for tokens if MCP is configured

## 1.1 GREPAI-FIRST RULE (MANDATORY)

**ALWAYS use grepai MCP for code search. NEVER use Grep tool directly.**

```yaml
grepai_workflow:
  step_1_check_index:
    tool: mcp__grepai__grepai_index_status
    verify: "total_files > 0"
    if_zero: "Wait for indexing or run /init"

  step_2_semantic_search:
    tool: mcp__grepai__grepai_search
    params:
      query: "natural language description of what you're looking for"
      limit: 10
    example: mcp__grepai__grepai_search(query="error handling in authentication")

  step_3_trace_analysis:
    tools:
      - mcp__grepai__grepai_trace_callers  # Who calls this function?
      - mcp__grepai__grepai_trace_callees  # What does this function call?
      - mcp__grepai__grepai_trace_graph    # Full call graph

  fallback_only_when:
    - "grepai MCP connection fails"
    - "index_status shows 0 files after /init"
    - "User explicitly requests Grep"
```

**When to use which tool:**

| Task | Use grepai | Use Grep |
|------|------------|----------|
| Find code by meaning | ✅ `grepai_search` | ❌ |
| Find function callers | ✅ `grepai_trace_callers` | ❌ |
| Exact string match (rare) | ❌ | ✅ |
| Regex pattern (rare) | ❌ | ✅ |
| grepai unavailable | ❌ | ✅ fallback |

## 2. ENVIRONMENT AWARENESS (MANDATORY)

**ALWAYS check environment variables and configuration files.**

```bash
# Check for tokens (masked output)
env | grep -E 'TOKEN|KEY|SECRET|API' | sed 's/=.*/=***/'

# Check project .env files
cat /workspace/.env 2>/dev/null
cat .devcontainer/.env 2>/dev/null
```

**Rules:**
- MCP tokens are pre-configured in `/workspace/mcp.json`
- NEVER ask user for tokens if environment provides them
- Check `.env` files before requesting credentials

## 3. NO AI MENTIONS IN COMMITS (MANDATORY)

**NEVER include AI references in commit messages.**

Forbidden patterns:
- `Co-Authored-By: Claude/Anthropic/OpenAI/AI/GPT/Copilot`
- `Generated by/with AI/Claude/GPT`
- `AI-assisted`, `ai assisted`
- Robot emoji, tool names (claude-code, chatgpt)

**Enforcement:** `commit-validate.sh` hook blocks violations automatically.

## 4. SKILLS & COMMANDS

**Available skills (use Skill tool to invoke):**

| Skill | Usage | Description |
|-------|-------|-------------|
| `/git` | `/git --commit` | Branch + commit + PR workflow |
| `/review` | `/review` | AI-powered code review |
| `/search` | `/search <topic>` | Documentation research |
| `/plan` | `/plan` | Enter planning mode |
| `/do` | `/do <task>` | Iterative task execution |
| `/test` | `/test` | E2E testing with Playwright |
| `/init` | `/init` | Project initialization check |
| `/update` | `/update` | DevContainer template update |
| `/improve` | `/improve` | Docs QA for design patterns |

## 5. CONTEXT HIERARCHY (MANDATORY)

**Read CLAUDE.md files for full project context.**

```
/workspace/CLAUDE.md                    # Project rules (primary)
├── .devcontainer/CLAUDE.md             # Container config
│   └── images/CLAUDE.md                # Docker image details
│       └── .claude/CLAUDE.md           # THIS FILE - Core rules
├── .devcontainer/features/CLAUDE.md    # Features overview
│   └── languages/*/RULES.md            # Language-specific rules
└── src/CLAUDE.md                       # Source code context
```

**Rules:**
- Read `/workspace/CLAUDE.md` at session start
- Read relevant CLAUDE.md when entering a directory
- UPDATE CLAUDE.md when modifying code structure
- More details deeper in tree, each <60 lines

## 6. GIT WORKFLOW (MANDATORY)

**NEVER commit directly to main/master.**

```bash
# WRONG - Direct commit to main
git commit -m "feat: something"
git push origin main

# CORRECT - Use /git skill
/git --commit   # Creates branch, commits, opens PR
```

**Enforcement:** Use `/git` skill which automatically:
1. Creates feature/fix branch
2. Commits with conventional format
3. Pushes to remote
4. Creates Pull Request

## 7. SAFEGUARDS (ABSOLUTE - NO BYPASS)

**NEVER delete without EXPLICIT user approval:**

```yaml
protected_paths:
  - .claude/           # Claude configuration
  - .devcontainer/     # Container configuration
  - .claude/commands/  # Skill definitions
  - .claude/scripts/   # Hook scripts
  - .claude/agents/    # Agent definitions
```

**When simplifying/refactoring:**
- Move content to separate files, NEVER delete logic
- Ask before removing any feature, even if seemingly redundant

## 8. CONTEXT RECOVERY (MANDATORY at Session Start)

**If session was interrupted, ALWAYS check for recovery context.**

```yaml
recovery_check:
  trigger: "New session OR compaction event"
  location: "/workspace/.claude/logs/<branch>/"
  files:
    checkpoint: "checkpoint.json"     # Last action snapshot
    session_log: "session.jsonl"      # Full action history

  workflow:
    1_get_branch: "git rev-parse --abbrev-ref HEAD"
    2_check_checkpoint: "cat /workspace/.claude/logs/<branch>/checkpoint.json"
    3_if_exists:
      - "Read last_event from checkpoint"
      - "Determine if task was incomplete"
      - "Resume from where it stopped"
    4_if_empty: "Start fresh session"
```

**Recovery commands:**

```bash
# Get current branch logs
BRANCH=$(git rev-parse --abbrev-ref HEAD | tr '/ ' '__')
LOG_DIR="/workspace/.claude/logs/$BRANCH"

# Read checkpoint (last action)
cat "$LOG_DIR/checkpoint.json" | jq .

# Read recent actions (last 20)
tail -n 20 "$LOG_DIR/session.jsonl" | jq -s .

# Read specific tool actions
grep '"tool_name":"Bash"' "$LOG_DIR/session.jsonl" | tail -5 | jq .
```

**Checkpoint structure:**

```json
{
  "last_update": "2026-01-15T10:30:00Z",
  "session_id": "abc123",
  "branch": "feat/my-feature",
  "commit": "a1b2c3d",
  "last_event": {
    "tool_name": "Edit",
    "tool_input": {"file_path": "/workspace/src/foo.ts"},
    "hook_event_name": "PostToolUse"
  },
  "recovery_hint": "Read checkpoint.json, tail session.jsonl"
}
```

**Rules:**
- Hooks log ALL tool actions (Bash, Write, Edit, Read, Glob, Grep, Task)
- Secrets are redacted, outputs truncated (safe to read)
- Logs are branch-scoped (isolated per feature branch)

## Quick Reference

```yaml
# Before ANY action, verify:
mcp_available: "Check mcp.json for configured servers"
env_tokens: "Check env vars for pre-configured auth"
commit_clean: "No AI mentions in message"
context_read: "Read relevant CLAUDE.md files"
branch_safe: "Not on main/master for commits"
recovery_check: "Check logs if resuming interrupted session"
```
